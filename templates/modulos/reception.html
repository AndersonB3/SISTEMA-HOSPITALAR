{% extends "modulos/base_modulo.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reception.css') }}">
{% endblock %}

{% block content %}
<!-- Container para Notificações Toast -->
<div class="toast-container" id="toastContainer"></div>

<div class="page-container">
    <!-- Botões de Alternância -->
    <div class="button-container">
        <button type="button" class="btn btn-primary btn-toggle active" data-form="cadastro">
            <i class="fas fa-user-plus"></i> Cadastro de Paciente
        </button>
        <button type="button" class="btn btn-primary btn-toggle" data-form="movimentacao">
            <i class="fas fa-notes-medical"></i> Movimentação
        </button>
    </div>

    <!-- Container dos Formulários -->
    <div class="form-container">
        <!-- Formulário de Cadastro -->
        <div id="cadastro" class="form-section-container active">
                <div class="form-header">
                    <h2>Cadastro de Paciente</h2>
                    
                    <!-- Campo de Pesquisa de Pacientes -->
                    <div class="search-patient-container mt-3">
                        <div class="input-group">
                            <input type="text" id="searchPatientInput" class="form-control" placeholder="Pesquisar paciente por nome, CPF ou prontuário...">
                            <button type="button" id="btnSearchPatient" class="btn btn-outline-secondary">
                                <i class="fas fa-search"></i>
                            </button>
                            <button type="button" id="btnClearSearch" class="btn btn-outline-danger" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Resultados da Pesquisa -->
                        <div id="searchResults" class="search-results" style="display: none;">
                            <div class="search-results-header">
                                <small class="text-muted">Resultados da pesquisa:</small>
                            </div>
                            <div id="searchResultsList" class="search-results-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Indicador de Modo Visualização -->
                <div id="viewModeIndicator" class="form-view-mode" style="display: none;">
                    <div class="view-info">
                        <i class="fas fa-eye"></i>
                        <span>Visualizando dados do paciente: <strong id="viewPatientName"></strong></span>
                    </div>
                    <div class="view-actions">
                        <button type="button" id="btnNewPatient" class="btn btn-new-patient">
                            <i class="fas fa-clipboard-list"></i> Adicionar Movimentação
                        </button>
                    </div>
                </div>

                <form id="patientForm" class="patient-form">
            <!-- Seção 1: Informações Básicas -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>
                    Informações Básicas
                </h3>
                
                <!-- Linha 1: Prontuário e Nome -->
                <div class="form-row">
                    <div class="form-group col-2">
                        <label for="prontuario">Nº Prontuário</label>
                        <input type="text" id="prontuario" class="form-control" readonly>
                    </div>
                    <div class="form-group col-8">
                        <label for="nome" class="required">Nome do Paciente</label>
                        <input type="text" id="nome" name="nome" class="form-control" required>
                    </div>
                    <div class="form-group col-2">
                        <div class="form-check ignorado-check">
                            <input type="checkbox" id="ignorado" class="form-check-input">
                            <label class="form-check-label" for="ignorado">Ignorado</label>
                        </div>
                    </div>
                </div>

                <!-- Linha 2: Data de Nascimento, RG, CPF -->
                <div class="form-row">
                    <div class="form-group col-4">
                        <label for="dataNascimento" class="required">Data de Nascimento</label>
                        <input type="date" id="dataNascimento" name="data_nascimento" class="form-control" required>
                    </div>
                    <div class="form-group col-4">
                        <label for="rg">RG <small>(RG ou CPF obrigatório)</small></label>
                        <input type="text" id="rg" name="rg" class="form-control" data-required-group="documento" placeholder="00.000.000-0">
                    </div>
                    <div class="form-group col-4">
                        <label for="cpf">CPF <small>(RG ou CPF obrigatório)</small></label>
                        <input type="text" id="cpf" name="cpf" class="form-control" data-required-group="documento" placeholder="000.000.000-00">
                        <div class="invalid-feedback">CPF inválido</div>
                        <div class="valid-feedback">CPF válido</div>
                    </div>
                </div>

                <!-- Linha 3: Sexo, Raça e Nacionalidade -->
                <div class="form-row">
                    <div class="form-group col-4">
                        <label for="sexo" class="required">Sexo</label>
                        <select id="sexo" name="sexo" class="form-select" required>
                            <option value="">Selecione</option>
                            <option value="M">Masculino</option>
                            <option value="F">Feminino</option>
                        </select>
                    </div>
                    <div class="form-group col-4">
                        <label for="raca" class="required">Raça</label>
                        <select id="raca" name="raca" class="form-select" required>
                            <option value="">Selecione</option>
                            <option value="branca">Branca</option>
                            <option value="preta">Preta</option>
                            <option value="parda">Parda</option>
                            <option value="amarela">Amarela</option>
                            <option value="indigena">Indígena</option>
                        </select>
                    </div>
                    <div class="form-group col-4">
                        <label for="nacionalidade">Nacionalidade</label>
                        <select id="nacionalidade" name="nacionalidade" class="form-select" required>
                            <option value="brasileiro" selected>Brasileiro</option>
                            <option value="estrangeiro">Estrangeiro</option>
                        </select>
                    </div>
                </div>

                <!-- Linha 4: Nome da Mãe e Nome do Pai -->
                <div class="form-row">
                    <div class="form-group col-5">
                        <label for="nomeMae" class="required">Nome da Mãe</label>
                        <input type="text" id="nomeMae" name="nome_mae" class="form-control" required>
                    </div>
                    <div class="form-group col-2">
                        <div class="form-check mae-check">
                            <input type="checkbox" id="maeDesconhecida" name="mae_desconhecida" class="form-check-input">
                            <label class="form-check-label" for="maeDesconhecida">Mãe Desconhecida</label>
                        </div>
                    </div>
                    <div class="form-group col-5">
                        <label for="nomePai">Nome do Pai</label>
                        <input type="text" id="nomePai" name="nome_pai" class="form-control">
                    </div>
                </div>

                <!-- Linha 5: Email e Telefone -->
                <div class="form-row">
                    <div class="form-group col-6">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" name="email" class="form-control">
                    </div>
                    <div class="form-group col-6">
                        <label for="telefone">Telefone</label>
                        <input type="tel" id="telefone" name="telefone" class="form-control">
                    </div>
                </div>
            </div>

            <!-- Seção 2: Convênio -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-id-card"></i>
                    Convênio
                </h3>
                <div class="form-row">
                    <div class="form-group col-4">
                        <label for="convenio">Convênio</label>
                        <select id="convenio" name="convenio" class="form-select" required>
                            <option value="sus" selected>SUS</option>
                            <option value="particular">Particular</option>
                            <option value="unimed">Unimed</option>
                            <option value="amil">Amil</option>
                            <option value="bradesco">Bradesco Saúde</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-group col-4">
                        <label for="numeroCartao">Número do Cartão</label>
                        <input type="text" id="numeroCartao" name="numero_cartao" class="form-control">
                    </div>
                    <div class="form-group col-4">
                        <label for="titularCartao">Titular do Cartão</label>
                        <input type="text" id="titularCartao" name="titular_cartao" class="form-control">
                    </div>
                </div>
            </div>

            <!-- Seção 3: Endereço -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Endereço
                </h3>
                
                <!-- Linha 1: CEP e Estado -->
                <div class="form-row">
                    <div class="form-group col-4">
                        <label for="cep" class="required">CEP</label>
                        <div class="input-group">
                            <input type="text" id="cep" name="cep" class="form-control" required placeholder="00000-000">
                            <button class="btn btn-outline-secondary" type="button" id="btnConsultarCep" title="Consultar CEP">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <small class="text-muted">Digite o CEP para preencher automaticamente</small>
                    </div>
                    <div class="form-group col-8">
                        <label for="estado" class="required">Estado</label>
                        <select id="estado" name="estado" class="form-select" required>
                            <option value="">Selecione</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>

                <!-- Linha 2: Cidade e Bairro -->
                <div class="form-row">
                    <div class="form-group col-6">
                        <label for="cidade" class="required">Cidade</label>
                        <input type="text" id="cidade" name="cidade" class="form-control" required>
                    </div>
                    <div class="form-group col-6">
                        <label for="bairro" class="required">Bairro</label>
                        <input type="text" id="bairro" name="bairro" class="form-control" required>
                    </div>
                </div>

                <!-- Linha 3: Logradouro e Número -->
                <div class="form-row">
                    <div class="form-group col-10">
                        <label for="logradouro" class="required">Logradouro</label>
                        <input type="text" id="logradouro" name="logradouro" class="form-control" required>
                    </div>
                    <div class="form-group col-2">
                        <label for="numero" class="required">Número</label>
                        <input type="text" id="numero" name="numero" class="form-control" required>
                    </div>
                </div>

                <!-- Linha 4: Complemento e Ponto de Referência -->
                <div class="form-row">
                    <div class="form-group col-6">
                        <label for="complemento">Complemento</label>
                        <input type="text" id="complemento" name="complemento" class="form-control">
                    </div>
                    <div class="form-group col-6">
                        <label for="pontoReferencia">Ponto de Referência</label>
                        <input type="text" id="pontoReferencia" name="ponto_referencia" class="form-control">
                    </div>
                </div>
            </div>
            
            <!-- Botões de Ação -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="btnSalvar">
                    <i class="fas fa-save"></i> Salvar
                </button>
                <button type="button" class="btn btn-primary" id="btnNovoCadastro">
                    <i class="fas fa-plus"></i> Novo Cadastro
                </button>
                <button type="button" class="btn btn-warning" id="btnEditar" style="display: none;">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" class="btn btn-warning" id="btnAtualizarPagina" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Atualizar Página
                </button>
            </div>
        </form>
            </div>
            
            <!-- Formulário de Movimentação -->
            <div id="movimentacao" class="form-section-container">
                <div class="form-header">
                    <h2>Movimentação de Atendimento</h2>
                </div>

                <!-- Container de Informações do Paciente Selecionado - Versão Compacta -->
                <div id="pacienteMovimentacaoInfo" class="patient-info-compact" style="display: none;">
                    <div class="compact-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-check text-primary me-2"></i>
                            <strong>Paciente Selecionado:</strong>
                            <span id="infoNomeCompact" class="ms-2 text-primary fw-bold">-</span>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="trocarPaciente()">
                            <i class="fas fa-exchange-alt"></i> Trocar
                        </button>
                    </div>
                    <div class="compact-details">
                        <div class="row g-2">
                            <div class="col-auto">
                                <span class="detail-label">Prontuário:</span>
                                <span id="infoProntuarioCompact" class="badge bg-primary">-</span>
                            </div>
                            <div class="col-auto">
                                <span class="detail-label">CPF:</span>
                                <span id="infoCpfCompact" class="detail-value">-</span>
                            </div>
                            <div class="col-auto">
                                <span class="detail-label">Idade:</span>
                                <span id="infoIdadeCompact" class="detail-value">-</span>
                            </div>
                            <div class="col-auto">
                                <span class="detail-label">Convênio:</span>
                                <span id="infoConvenioCompact" class="detail-value">-</span>
                            </div>
                            <div class="col-auto">
                                <span class="detail-label">Status:</span>
                                <span id="infoStatusCompact" class="badge bg-warning text-dark">Sem Movimentação</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seção de Histórico de Movimentações -->
                <div class="historico-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="section-title mb-0">Histórico de Movimentações</h3>
                        <button type="button" class="btn btn-primary" id="btnAdicionarCustom">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Movimentação</th>
                                    <th>Profissional Responsável</th>
                                    <th>Status</th>
                                    <th>Entrada</th>
                                    <th>Saída</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="historicoMovimentacoes">
                                <!-- Os dados serão inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal Customizado para Nova Movimentação -->
                <div class="modal-custom" id="modalCustomMovimentacao">
                    <div class="modal-custom-content">
                        <div class="modal-custom-header">
                            <h5>Nova Movimentação</h5>
                            <button type="button" class="modal-custom-close" id="btnFecharModalCustom">&times;</button>
                        </div>
                        <div class="modal-custom-body">
                            <form id="formMovimentacaoCustom">
                                <!-- Tipo -->
                                <div class="mb-3">
                                    <label for="tipoCustom" class="form-label">Tipo</label>
                                    <select class="form-select" id="tipoCustom" required>
                                        <option value="">Selecione</option>
                                        <option value="emergencia">Emergência</option>
                                    </select>
                                </div>

                                <!-- Status -->
                                <div class="mb-3">
                                    <label for="statusCustom" class="form-label">Status</label>
                                    <select class="form-select" id="statusCustom" required>
                                        <option value="">Selecione</option>
                                        <option value="aguardando_acolhimento">Aguardando Acolhimento</option>
                                        <option value="em_acolhimento">Em Acolhimento</option>
                                        <option value="aguardando_atendimento">Aguardando Atendimento</option>
                                        <option value="em_atendimento">Em Atendimento</option>
                                        <option value="concluido">Concluído</option>
                                        <option value="cancelado">Cancelado</option>
                                        <option value="acompanhamento_ambulatorial">Acompanhamento Ambulatorial</option>
                                        <option value="transferencia">Transferência</option>
                                        <option value="alta_medica">Alta Médica</option>
                                        <option value="internado">Internado</option>
                                        <option value="em_observacao">Em Observação</option>
                                        <option value="aguardando_internamento">Aguardando Internamento</option>
                                    </select>
                                </div>

                                <!-- Prioridade -->
                                <div class="mb-3">
                                    <label for="prioridadeCustom" class="form-label">Prioridade <span class="text-muted">(Opcional)</span></label>
                                    <select class="form-select" id="prioridadeCustom">
                                        <option value="">Selecione (opcional)</option>
                                        <option value="idoso_60">Idoso 60+</option>
                                        <option value="idoso_80">Idoso 80+</option>
                                        <option value="raio_x">Raio-X</option>
                                        <option value="gestante">Gestante</option>
                                        <option value="lactante">Lactante</option>
                                        <option value="pessoa_crianca_colo">Pessoa com Criança de Colo</option>
                                        <option value="mobilidade_reduzida">Pessoa com Mobilidade Reduzida</option>
                                        <option value="espectro_autista">Espectro Autista</option>
                                        <option value="obeso">Obeso</option>
                                        <option value="sala_vermelha">Sala Vermelha</option>
                                    </select>
                                </div>

                                <!-- Botões -->
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary" id="btnCancelarCustom">Fechar</button>
                                    <button type="submit" class="btn btn-primary">Salvar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <style>
                    /* Estilos para modal customizado mais simples */
                    .modal-custom {
                        display: none;
                        position: fixed;
                        z-index: 9999;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0, 0, 0, 0.5);
                        animation: fadeIn 0.3s;
                    }
                    
                    .modal-custom.show {
                        display: flex !important;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .modal-custom-content {
                        background-color: #fff;
                        padding: 0;
                        border-radius: 8px;
                        width: 90%;
                        max-width: 600px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                        animation: slideIn 0.3s;
                    }
                    
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateY(-50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    
                    .modal-custom-header {
                        padding: 1rem;
                        border-bottom: 1px solid #dee2e6;
                        display: flex;
                        justify-content: between;
                        align-items: center;
                    }
                    
                    .modal-custom-body {
                        padding: 1.5rem;
                    }
                    
                    .modal-custom-close {
                        background: none;
                        border: none;
                        font-size: 1.5rem;
                        cursor: pointer;
                        padding: 0;
                        margin-left: auto;
                    }
                    
                    /* Estilos originais do Bootstrap para fallback */
                    .modal {
                        z-index: 1055 !important;
                    }
                    
                    .modal-backdrop {
                        z-index: 1050 !important;
                    }
                    
                    .modal-dialog {
                        margin: 1.75rem auto;
                        max-width: 500px;
                    }
                    
                    .modal-lg {
                        max-width: 800px;
                    }
                    
                    .modal-content {
                        background-color: #fff;
                        border: 1px solid #dee2e6;
                        border-radius: 0.375rem;
                        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                    }
                    
                    .modal-header {
                        padding: 1rem 1rem;
                        border-bottom: 1px solid #dee2e6;
                    }
                    
                    .modal-body {
                        padding: 1rem;
                    }
                    
                    .modal-footer {
                        padding: 1rem;
                        border-top: 1px solid #dee2e6;
                    }
                    
                    .status-badge {
                        display: inline-block;
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 500;
                        text-align: center;
                        white-space: nowrap;
                    }
                    
                    .status-em-andamento {
                        background-color: #ffd700;
                        color: #000;
                    }
                    
                    .status-aguardando {
                        background-color: #17a2b8;
                        color: #fff;
                    }
                    
                    .status-concluido {
                        background-color: #28a745;
                        color: #fff;
                    }
                    
                    .status-cancelado {
                        background-color: #dc3545;
                        color: #fff;
                    }
                    
                    .btn-acao {
                        padding: 4px 8px;
                        margin: 0 2px;
                    }
                    
                .btn-acao i {
                    font-size: 14px;
                }

                /* Estilos para a seção de pesquisa */
                .search-container {
                    background: #fff;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    margin-top: 20px;
                }

                #searchInput {
                    border-right: none;
                }

                #btnPesquisar {
                    border-top-left-radius: 0;
                    border-bottom-left-radius: 0;
                }

                #searchType {
                    height: 100%;
                }
                </style>                <style>
                    .historico-container {
                        background: #fff;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        margin-top: 20px;
                    }

                    .table {
                        width: 100%;
                        margin-bottom: 1rem;
                        background-color: transparent;
                        border-collapse: collapse;
                    }

                    .table thead th {
                        vertical-align: bottom;
                        border-bottom: 2px solid #dee2e6;
                        padding: 12px;
                        font-weight: 600;
                        color: #495057;
                        background-color: #f8f9fa;
                    }

                    .table tbody td {
                        padding: 12px;
                        vertical-align: middle;
                        border-top: 1px solid #dee2e6;
                    }

                    .table-hover tbody tr:hover {
                        background-color: rgba(0,0,0,.075);
                    }

                    .table-striped tbody tr:nth-of-type(odd) {
                        background-color: rgba(0,0,0,.05);
                    }

                    .table-responsive {
                        display: block;
                        width: 100%;
                        overflow-x: auto;
                        -webkit-overflow-scrolling: touch;
                        -ms-overflow-style: -ms-autohiding-scrollbar;
                    }

                    .status-badge {
                        padding: 5px 10px;
                        border-radius: 15px;
                        font-size: 12px;
                        font-weight: 600;
                    }

                    .status-em-andamento {
                        background-color: #ffd700;
                        color: #000;
                    }

                    .status-concluido {
                        background-color: #28a745;
                        color: #fff;
                    }

                    .status-cancelado {
                        background-color: #dc3545;
                        color: #fff;
                    }

                    .btn-acao {
                        padding: 4px 8px;
                        font-size: 14px;
                        margin: 0 2px;
                    }
                </style>

                <!-- Modal para Visualização de Paciente -->
<div class="modal fade" id="modalVisualizarPaciente" tabindex="-1" aria-labelledby="modalVisualizarPacienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalVisualizarPacienteLabel">
                    <i class="fas fa-user"></i> Dados do Paciente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="dadosPaciente">
                <!-- Dados serão carregados via JavaScript -->
                <div class="text-center">
                    <div class="loading-spinner"></div>
                    <p>Carregando dados do paciente...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" id="btnImprimirEtiquetaModal">
                    <i class="fas fa-print"></i> Imprimir Etiqueta
                </button>
                <button type="button" class="btn btn-warning" id="btnEditarPacienteModal">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Confirmação de Ações -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmacaoLabel">
                    <i class="fas fa-question-circle"></i> Confirmação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="mensagemConfirmacao">
                <!-- Mensagem será inserida via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmarAcao">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>                <style>
                    .modal-dialog-centered {
                        display: flex;
                        align-items: center;
                        min-height: calc(100% - 1rem);
                    }
                    
                    .modal-content {
                        border-radius: 8px;
                        border: none;
                        box-shadow: 0 0 20px rgba(0,0,0,0.15);
                    }
                    
                    .modal-header {
                        border-bottom: 1px solid #dee2e6;
                        background-color: #f8f9fa;
                        border-top-left-radius: 8px;
                        border-top-right-radius: 8px;
                        padding: 1rem 1.5rem;
                    }
                    
                    .modal-body {
                        padding: 0;
                    }
                    
                    .modal-dialog.modal-lg {
                        max-width: 800px;
                    }
                </style>
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/reception.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM carregado, inicializando sistema...');
        
        // Verificar se Bootstrap está disponível
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap não está carregado!');
            showError('Erro de Sistema', 'Bootstrap não carregado. Recarregue a página.');
            return;
        }
        
        console.log('Bootstrap disponível:', bootstrap);
        
        // Controle da visibilidade das seções
        document.querySelectorAll('.btn-toggle').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active de todos os botões
                document.querySelectorAll('.btn-toggle').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Adiciona active ao botão clicado
                this.classList.add('active');
                
                // Esconde todas as seções
                document.querySelectorAll('.form-section-container').forEach(container => {
                    container.classList.remove('active');
                });
                
                // Mostra a seção correspondente
                const targetForm = this.getAttribute('data-form');
                document.getElementById(targetForm).classList.add('active');
                
                // Se mudou para movimentação e há paciente selecionado, mostrar info
                if (targetForm === 'movimentacao' && pacienteSelecionado) {
                    // Verificar se as informações já estão carregadas
                    const pacienteInfoContainer = document.getElementById('pacienteMovimentacaoInfo');
                    if (pacienteInfoContainer && pacienteInfoContainer.style.display === 'none') {
                        loadPatientInfoInMovementTab(pacienteSelecionado);
                    }
                } else if (targetForm === 'movimentacao') {
                    // Se não há paciente selecionado, verificar se há dados no formulário de cadastro
                    const patientName = document.getElementById('viewPatientName');
                    if (patientName && patientName.textContent.trim()) {
                        const patientData = {
                            nome: patientName.textContent.trim(),
                            prontuario: document.getElementById('prontuario').value,
                            cpf: document.getElementById('cpf').value,
                            data_nascimento: document.getElementById('dataNascimento').value,
                            convenio: document.getElementById('convenio').value,
                            sexo: document.getElementById('sexo').value
                        };
                        loadPatientInfoInMovementTab(patientData);
                    }
                }
            });
        });

        // Funcionalidade de pesquisa melhorada
        initPesquisaIntegrada();
        
        // Função para formatar data e hora
        function formatarDataHora(data) {
            if (!data) return '-';
            return new Intl.DateTimeFormat('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(new Date(data));
        }

        // Função para criar badge de status
        function criarBadgeStatus(status) {
            const statusClasses = {
                'aguardando_acolhimento': 'bg-warning text-dark',
                'em_acolhimento': 'bg-info',
                'aguardando_atendimento': 'bg-warning text-dark',
                'em_atendimento': 'bg-primary',
                'concluido': 'bg-success',
                'cancelado': 'bg-danger',
                'acompanhamento_ambulatorial': 'bg-secondary',
                'transferencia': 'bg-dark',
                'alta_medica': 'bg-success',
                'internado': 'bg-danger',
                'em_observacao': 'bg-info',
                'aguardando_internamento': 'bg-warning text-dark'
            };

            const statusNomes = {
                'aguardando_acolhimento': 'Aguardando Acolhimento',
                'em_acolhimento': 'Em Acolhimento',
                'aguardando_atendimento': 'Aguardando Atendimento',
                'em_atendimento': 'Em Atendimento',
                'concluido': 'Concluído',
                'cancelado': 'Cancelado',
                'acompanhamento_ambulatorial': 'Acompanhamento Ambulatorial',
                'transferencia': 'Transferência',
                'alta_medica': 'Alta Médica',
                'internado': 'Internado',
                'em_observacao': 'Em Observação',
                'aguardando_internamento': 'Aguardando Internamento'
            };

            const classe = statusClasses[status] || 'bg-secondary';
            const nome = statusNomes[status] || status;
            
            return `<span class="badge ${classe}">${nome}</span>`;
        }

        // Botão para modal customizado
        const btnAdicionarCustom = document.getElementById('btnAdicionarCustom');
        if (btnAdicionarCustom) {
            btnAdicionarCustom.addEventListener('click', function() {
                console.log('Botão adicionar custom clicado');
                
                // Usar a nova função de verificação robusta
                const paciente = verificarPacienteSelecionado();
                
                if (!paciente) {
                    showWarning(
                        'Nenhum Paciente Selecionado', 
                        'Para registrar uma movimentação, siga estes passos:<br><br>' +
                        '1️⃣ Vá para a aba <strong>"Cadastro de Paciente"</strong><br>' +
                        '2️⃣ Pesquise um paciente existente ou cadastre um novo<br>' +
                        '3️⃣ Selecione o paciente desejado<br>' +
                        '4️⃣ Retorne para esta aba <strong>"Movimentação"</strong><br>' +
                        '5️⃣ Clique em <strong>"Adicionar"</strong> novamente<br><br>' +
                        '<em>💡 Dica: Você verá as informações do paciente aparecerem nesta aba quando ele estiver selecionado.</em>'
                    );
                    return;
                }
                
                console.log(`✅ Paciente válido selecionado: ${paciente.nome} (ID: ${paciente.id})`);
                
                // Garantir que a variável global está atualizada
                pacienteSelecionado = paciente;
                
                // Sincronizar dados com a aba atual (caso necessário)
                updateMovementTabWithPatient(paciente);
                
                // Abrir modal customizado
                const modalCustom = document.getElementById('modalCustomMovimentacao');
                if (modalCustom) {
                    modalCustom.classList.add('show');
                    document.body.style.overflow = 'hidden'; // Prevenir scroll da página
                    
                    // Focar no primeiro campo do modal
                    setTimeout(() => {
                        const primeirocampo = modalCustom.querySelector('select, input');
                        if (primeirocampo) primeirocampo.focus();
                    }, 100);
                    
                    console.log('Modal customizado aberto');
                } else {
                    console.error('Modal customizado não encontrado');
                    showError('Erro', 'Interface de movimentação não encontrada. Recarregue a página.');
                }
            });
        }

        // Fechar modal customizado
        const btnFecharModalCustom = document.getElementById('btnFecharModalCustom');
        const btnCancelarCustom = document.getElementById('btnCancelarCustom');
        
        function fecharModalCustom() {
            const modalCustom = document.getElementById('modalCustomMovimentacao');
            if (modalCustom) {
                modalCustom.classList.remove('show');
                document.body.style.overflow = ''; // Restaurar scroll da página
                console.log('Modal customizado fechado');
            }
        }
        
        if (btnFecharModalCustom) {
            btnFecharModalCustom.addEventListener('click', fecharModalCustom);
        }
        
        if (btnCancelarCustom) {
            btnCancelarCustom.addEventListener('click', fecharModalCustom);
        }

        // Fechar modal ao clicar fora dele
        const modalCustomMovimentacao = document.getElementById('modalCustomMovimentacao');
        if (modalCustomMovimentacao) {
            modalCustomMovimentacao.addEventListener('click', function(e) {
                if (e.target === modalCustomMovimentacao) {
                    fecharModalCustom();
                }
            });
        }

        // Botão Novo Cadastro - Atualizar página
        const btnNovoCadastro = document.getElementById('btnNovoCadastro');
        if (btnNovoCadastro) {
            btnNovoCadastro.addEventListener('click', function() {
                console.log('Botão Novo Cadastro clicado - Atualizando página');
                
                // Atualizar a página diretamente
                location.reload();
            });
        }

        // Botão Editar - Entrar no modo de edição
        const btnEditar = document.getElementById('btnEditar');
        if (btnEditar) {
            btnEditar.addEventListener('click', function() {
                console.log('Botão Editar clicado');
                enterEditMode();
            });
        }

        // Botão Atualizar Página - Recarregar quando pesquisa não encontrar paciente
        const btnAtualizarPagina = document.getElementById('btnAtualizarPagina');
        if (btnAtualizarPagina) {
            btnAtualizarPagina.addEventListener('click', function() {
                console.log('Botão Atualizar Página clicado');
                
                // Confirmar antes de recarregar
                if (confirm('Tem certeza que deseja atualizar a página? Todos os dados não salvos serão perdidos.')) {
                    location.reload();
                } else {
                    console.log('Atualização da página cancelada pelo usuário');
                }
            });
        }

        // Formulário do modal customizado
        const formMovimentacaoCustom = document.getElementById('formMovimentacaoCustom');
        if (formMovimentacaoCustom) {
            formMovimentacaoCustom.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Formulário customizado enviado - chamando salvarMovimentacao()');
                
                // Verificar novamente se há paciente válido
                const paciente = verificarPacienteSelecionado();
                if (!paciente) {
                    showError('Paciente Não Encontrado', 
                        'Nenhum paciente foi selecionado para esta movimentação.<br>' +
                        'Feche este modal e selecione um paciente primeiro na aba "Cadastro de Paciente".'
                    );
                    return;
                }
                
                console.log(`✅ Paciente confirmado para movimentação: ${paciente.nome} (ID: ${paciente.id})`);
                
                // Atualizar variável global
                pacienteSelecionado = paciente;
                
                try {
                    // Chamar a função principal de salvar movimentação (que salvará na API)
                    await salvarMovimentacao();
                    
                    // Se chegou até aqui, a movimentação foi salva com sucesso
                    // Fechar o modal
                    fecharModalCustom();
                    
                    // Limpar o formulário
                    this.reset();
                    console.log('Movimentação salva com sucesso via modal customizado');
                    
                } catch (error) {
                    console.error('Erro ao salvar movimentação via modal:', error);
                    showError('Erro', 'Erro ao salvar movimentação. Tente novamente.');
                }
            });
        }

        // Auto-preenchimento para modal customizado
        const tipoCustomSelect = document.getElementById('tipoCustom');
        if (tipoCustomSelect) {
            tipoCustomSelect.addEventListener('change', function() {
                if (this.value === 'emergencia') {
                    document.getElementById('statusCustom').value = 'aguardando_acolhimento';
                }
            });
        }

        // Função para pesquisa integrada
        function initPesquisaIntegrada() {
            const btnPesquisar = document.getElementById('btnPesquisar');
            const searchInput = document.getElementById('searchInput');
            
            if (btnPesquisar) {
                btnPesquisar.addEventListener('click', function() {
                    const searchTerm = searchInput.value.trim();
                    const searchType = document.getElementById('searchType').value;
                    
                    if (!searchTerm) {
                        showWarning('Termo de Pesquisa Obrigatório', 'Digite pelo menos um termo para realizar a pesquisa de pacientes.');
                        return;
                    }
                    
                    realizarPesquisaIntegrada(searchTerm, searchType);
                });
            }
            
            if (searchInput) {
                // Pesquisa ao pressionar Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        btnPesquisar.click();
                    }
                });
                
                // Pesquisa automática após 3 caracteres
                let timeoutId;
                searchInput.addEventListener('input', function() {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        if (this.value.length >= 3) {
                            desabilitarBotoesFormulario();
                            realizarPesquisaIntegrada(this.value);
                        } else if (this.value.length === 0) {
                            habilitarBotoesFormulario();
                            limparResultadosPesquisa();
                        }
                    }, 500);
                });
            }
        }
        
        // Função de pesquisa integrada
        function realizarPesquisaIntegrada(termo, tipo = '') {
            showInfo('Buscando Pacientes', 'Realizando pesquisa no banco de dados de pacientes...');
            
            fetch(`/api/pacientes?search=${encodeURIComponent(termo)}${tipo ? '&type=' + tipo : ''}`, {
                credentials: 'include'  // Incluir cookies de sessão
            })
                .then(response => response.json())
                .then(resultados => {
                    exibirResultadosIntegrados(resultados);
                })
                .catch(error => {
                    console.error('Erro na pesquisa:', error);
                    showError('Falha na Pesquisa', 'Não foi possível realizar a pesquisa de pacientes. Verifique sua conexão e tente novamente.');
                });
        }

        // Função para desabilitar botões do formulário durante pesquisa
        function desabilitarBotoesFormulario() {
            const btnSalvar = document.getElementById('btnSalvar');
            const btnNovoCadastro = document.getElementById('btnNovoCadastro');
            const btnEditar = document.getElementById('btnEditar');
            const btnAtualizarPagina = document.getElementById('btnAtualizarPagina');

            // Desabilitar botões principais
            if (btnSalvar) {
                btnSalvar.disabled = true;
                btnSalvar.style.opacity = '0.5';
                btnSalvar.title = 'Não disponível durante a pesquisa';
            }
            
            if (btnNovoCadastro) {
                btnNovoCadastro.disabled = true;
                btnNovoCadastro.style.opacity = '0.5';
                btnNovoCadastro.title = 'Não disponível durante a pesquisa';
            }
            
            if (btnEditar) {
                btnEditar.disabled = true;
                btnEditar.style.opacity = '0.5';
                btnEditar.title = 'Não disponível durante a pesquisa';
            }

            // Mostrar botão de atualizar página
            if (btnAtualizarPagina) {
                btnAtualizarPagina.style.display = 'inline-block';
            }

            console.log('Botões desabilitados - Modo pesquisa ativo');
        }

        // Função para habilitar botões do formulário
        function habilitarBotoesFormulario() {
            const btnSalvar = document.getElementById('btnSalvar');
            const btnNovoCadastro = document.getElementById('btnNovoCadastro');
            const btnEditar = document.getElementById('btnEditar');
            const btnAtualizarPagina = document.getElementById('btnAtualizarPagina');

            // Habilitar botões principais
            if (btnSalvar) {
                btnSalvar.disabled = false;
                btnSalvar.style.opacity = '1';
                btnSalvar.title = '';
            }
            
            if (btnNovoCadastro) {
                btnNovoCadastro.disabled = false;
                btnNovoCadastro.style.opacity = '1';
                btnNovoCadastro.title = '';
            }
            
            if (btnEditar) {
                btnEditar.disabled = false;
                btnEditar.style.opacity = '1';
                btnEditar.title = '';
            }

            // Ocultar botão de atualizar página
            if (btnAtualizarPagina) {
                btnAtualizarPagina.style.display = 'none';
            }

            console.log('Botões habilitados - Modo pesquisa desativado');
        }
        
        // Função para exibir resultados integrados
        function exibirResultadosIntegrados(resultados) {
            const tbody = document.getElementById('searchResults');
            const searchStats = document.getElementById('searchStats');
            const resultCount = document.getElementById('resultCount');
            
            if (!tbody) return;

            tbody.innerHTML = '';

            if (resultados.error) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-5">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                            <br>
                            <strong>Erro na pesquisa</strong>
                            <br>
                            <small>${resultados.error}</small>
                        </td>
                    </tr>
                `;
                return;
            }

            if (resultados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="fas fa-search-minus fa-3x mb-3 text-warning"></i>
                            <br>
                            <strong>Nenhum paciente encontrado</strong>
                            <br>
                            <small>Tente usar termos diferentes para sua pesquisa</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Mostrar estatísticas
            if (searchStats && resultCount) {
                resultCount.textContent = resultados.length;
                searchStats.style.display = 'block';
                setTimeout(() => {
                    searchStats.classList.add('show');
                }, 100);
            }

            resultados.forEach(paciente => {
                const tr = document.createElement('tr');
                tr.className = 'resultado-paciente clickable';
                tr.setAttribute('data-paciente-id', paciente.id);
                tr.style.cursor = 'pointer';
                
                tr.innerHTML = `
                    <td>
                        <span class="badge bg-secondary">${paciente.prontuario}</span>
                    </td>
                    <td>
                        <strong>${paciente.nome}</strong>
                        <br><small class="text-muted">Clique para iniciar atendimento</small>
                    </td>
                    <td>
                        <small class="text-muted">${paciente.cpf || 'Não informado'}</small>
                    </td>
                    <td>
                        <small class="text-muted">${paciente.rg || 'Não informado'}</small>
                    </td>
                    <td>
                        <small>${new Date(paciente.data_nascimento).toLocaleDateString('pt-BR')}</small>
                    </td>
                    <td>
                        <div class="btn-group" role="group" aria-label="Ações">
                            <button class="btn btn-sm btn-success btn-acao" onclick="iniciarAtendimento(${paciente.id}, '${paciente.nome}', '${paciente.prontuario}'); event.stopPropagation();" title="Iniciar Atendimento">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-primary btn-acao" onclick="visualizarPaciente(${paciente.id}); event.stopPropagation();" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning btn-acao" onclick="editarPaciente(${paciente.id}); event.stopPropagation();" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-info btn-acao" onclick="imprimirEtiqueta(${paciente.id}); event.stopPropagation();" title="Imprimir Etiqueta">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                // Adicionar evento de clique na linha inteira
                tr.addEventListener('click', function() {
                    iniciarAtendimento(paciente.id, paciente.nome, paciente.prontuario);
                });
                
                tbody.appendChild(tr);
            });

            showSuccess('Pesquisa Concluída', `Foram encontrados <strong>${resultados.length}</strong> paciente(s) correspondente(s) à sua busca.`);
        }
        
        // Função para limpar resultados
        function limparResultadosPesquisa() {
            const tbody = document.getElementById('searchResults');
            const searchStats = document.getElementById('searchStats');
            
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="fas fa-search fa-3x mb-3 text-secondary"></i>
                            <br>
                            <strong>Nenhuma pesquisa realizada</strong>
                            <br>
                            <small>Digite pelo menos 3 caracteres para iniciar a pesquisa</small>
                        </td>
                    </tr>
                `;
            }
            
            // Habilitar botões quando não há pesquisa ativa
            habilitarBotoesFormulario();
            
            // Ocultar estatísticas
            if (searchStats) {
                searchStats.classList.remove('show');
                setTimeout(() => {
                    searchStats.style.display = 'none';
                }, 300);
            }
        }
        
        // Funções globais para editar e excluir movimentação
        window.editarMovimentacao = function(index) {
            showInfo('Funcionalidade em Desenvolvimento', 'A edição de movimentações estará disponível em breve.');
        };
        
        // As funções de notificação Toast são fornecidas pelo notifications.js
        // showSuccess, showError, showWarning, showInfo estão disponíveis globalmente
        
        function confirmarAcao(mensagem, callback) {
            if (confirm(mensagem)) {
                callback();
            }
        }

        // Função para atualizar o status do paciente no container
        function updatePatientStatus(status, tipo) {
            const statusElement = document.getElementById('infoStatus');
            const ultimaMovimentacaoElement = document.getElementById('infoUltimaMovimentacao');
            
            if (statusElement) {
                // Mapear status para texto mais amigável
                const statusMap = {
                    'aguardando_acolhimento': 'Aguardando Acolhimento',
                    'em_acolhimento': 'Em Acolhimento',
                    'aguardando_atendimento': 'Aguardando Atendimento',
                    'em_atendimento': 'Em Atendimento',
                    'concluido': 'Concluído',
                    'cancelado': 'Cancelado',
                    'acompanhamento_ambulatorial': 'Acompanhamento Ambulatorial',
                    'transferencia': 'Transferência',
                    'alta_medica': 'Alta Médica',
                    'internado': 'Internado',
                    'em_observacao': 'Em Observação',
                    'aguardando_internamento': 'Aguardando Internamento'
                };
                
                const statusText = statusMap[status] || status;
                statusElement.textContent = statusText;
                
                // Atualizar classes do badge baseado no status
                statusElement.className = 'info-value badge';
                if (status.includes('aguardando')) {
                    statusElement.classList.add('bg-warning', 'text-dark');
                } else if (status.includes('em_')) {
                    statusElement.classList.add('bg-primary');
                } else if (status === 'concluido' || status === 'alta_medica') {
                    statusElement.classList.add('bg-success');
                } else if (status === 'cancelado' || status === 'internado') {
                    statusElement.classList.add('bg-danger');
                } else {
                    statusElement.classList.add('bg-info');
                }
            }
            
            if (ultimaMovimentacaoElement) {
                const agora = new Date();
                const timeString = agora.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const tipoMap = {
                    'emergencia': 'Emergência'
                };
                
                const tipoText = tipoMap[tipo] || tipo;
                ultimaMovimentacaoElement.textContent = `${tipoText} - ${timeString}`;
            }
        }

        // Script de depuração para busca (modo desenvolvimento)
        function debugSearchElements() {
            console.log('🔍 DEBUG - Verificando elementos de busca...');
            
            const elements = {
                searchInput: document.getElementById('searchPatientInput'),
                btnSearch: document.getElementById('btnSearchPatient'),
                btnClear: document.getElementById('btnClearSearch'),
                searchResults: document.getElementById('searchResults'),
                searchResultsList: document.getElementById('searchResultsList')
            };
            
            console.log('📋 Elementos encontrados:');
            Object.entries(elements).forEach(([name, element]) => {
                if (element) {
                    console.log(`✅ ${name}: encontrado`, element);
                } else {
                    console.log(`❌ ${name}: NÃO encontrado`);
                }
            });
            
            // Verificar função de busca
            if (typeof searchPatients === 'function') {
                console.log('✅ Função searchPatients existe');
                
                // Testar busca direta
                console.log('🧪 Testando busca direta com "João"...');
                searchPatients('João').catch(error => {
                    console.error('❌ Erro na busca:', error);
                });
            } else {
                console.log('❌ Função searchPatients NÃO existe');
            }
            
            return elements;
        }
        
        // FUNÇÃO DE BUSCA SIMPLIFICADA PARA DEBUG
        async function debugSimpleSearch(query) {
            console.log(`🔍 DEBUG - Busca simples por: "${query}"`);
            
            try {
                const url = `/api/pacientes?search=${encodeURIComponent(query)}`;
                console.log(`📡 URL: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log(`📡 Status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`✅ Dados recebidos:`, data);
                    
                    // Exibir na interface
                    const searchResults = document.getElementById('searchResults');
                    const searchResultsList = document.getElementById('searchResultsList');
                    
                    if (searchResults && searchResultsList) {
                        if (data.length > 0) {
                            let html = '';
                            data.forEach(patient => {
                                html += `
                                    <div class="search-result-item" onclick="selectPatientForView(${patient.id})">
                                        <div class="patient-name">${patient.nome}</div>
                                        <div class="patient-details">
                                            <span>Prontuário: ${patient.prontuario}</span>
                                            ${patient.cpf ? `<span>CPF: ${patient.cpf}</span>` : ''}
                                            <span>Nascimento: ${patient.data_nascimento || 'N/A'}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            searchResultsList.innerHTML = html;
                            searchResults.style.display = 'block';
                            console.log(`✅ Interface atualizada com ${data.length} resultados`);
                        } else {
                            searchResultsList.innerHTML = '<div class="search-empty">Nenhum paciente encontrado</div>';
                            searchResults.style.display = 'block';
                            console.log('ℹ️ Nenhum resultado encontrado');
                        }
                    } else {
                        console.log('❌ Elementos de resultado não encontrados');
                    }
                    
                    return data;
                } else {
                    const errorText = await response.text();
                    console.error(`❌ Erro ${response.status}:`, errorText);
                    return null;
                }
                
            } catch (error) {
                console.error('❌ Erro na busca:', error);
                return null;
            }
        }
        
        // Debug functions removed for production
        // Functions available in development mode only
        
    });
</script>
{% endblock %}